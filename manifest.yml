app:
  id: ari:cloud:ecosystem::app/c7104b49-0a91-46dc-b2c6-de1b156b9b96
  runtime:
    name: nodejs20.x

permissions:
  scopes:
    - storage:app
    - read:jira-work
    - write:jira-work
    - read:content-details:confluence
    - read:content.property:confluence
    - read:confluence-content.all
    - write:confluence-content
    - read:space:confluence
    - write:page:confluence
    - write:content.property:confluence
    - read:chat:rovo
  content:
    styles:
      - 'unsafe-inline'
    scripts:
      - 'unsafe-inline'
      - 'unsafe-eval'
      
  external:
    fetch:
      backend:
        - https://api.bitbucket.org
      client:
        - 'https://esm.sh'
        - 'https://api.openai.com'
        
    images:
      - https://cdn-icons-png.flaticon.com
    

providers:
  auth:
    - key: bitbucket-oauth-v2
      name: Bitbucket Cloud
      type: oauth2
      clientId: "waVaGANqwNGGRqMapM"
      remotes:
        - bitbucket-api
      bearerMethod: authorization-header
      scopes:
        - account
        - repository
      actions:
        authorization:
          # ‚úÖ FIX 1: Points to the WEBSITE remote (not API)
          remote: bitbucket-website
          path: /site/oauth2/authorize
        exchange:
          # ‚úÖ FIX 2: Points to the WEBSITE remote
          remote: bitbucket-website
          path: /site/oauth2/access_token
        retrieveProfile:
          # Keep this pointing to API
          remote: bitbucket-api
          path: /2.0/user
          resolvers:
            id: account_id
            displayName: display_name
            avatarUrl: links.avatar.href

remotes:
  - key: bitbucket-api
    baseUrl: https://api.bitbucket.org
  
  # ‚úÖ FIX 3: Added the Website URL for Login
  - key: bitbucket-website
    baseUrl: https://bitbucket.org

modules:
  confluence:contextMenu:
    - key: dictionary
      function: main
      title: Define word

  function:
    - key: main
      handler: index.run
      providers:
        auth:
          - bitbucket-oauth-v2

    - key: main-resolver
      handler: index.mainResolver
      providers:
        auth:
          - bitbucket-oauth-v2

    - key: invoke-create-draft
      handler: index.invokeCreateDraft
      providers:
        auth:
          - bitbucket-oauth-v2

    - key: cddh
      handler: index.createDesignDraftHandler
      providers:
        auth:
          - bitbucket-oauth-v2

    - key: psh
      handler: index.prescribeSolutionHandler
      providers:
        auth:
          - bitbucket-oauth-v2

    - key: trigger-fn
      handler: index.triggerHandler
      providers:
        auth:
          - bitbucket-oauth-v2

  trigger:
    - key: issue-created-trigger
      function: trigger-fn
      events:
        - avi:jira:created:issue

  # ‚úÖ Global Page (The "Emergency Entrance" for Login)
  jira:globalPage:
    - key: pit-wall-global
      resource: pit-wall-resource
      resolver:
        function: main-resolver
      title: üèÅ Pit Wall Auth
      icon: https://cdn-icons-png.flaticon.com/512/555/555646.png

  # ‚úÖ Issue Panel (The main UI on tickets)
  jira:issuePanel:
    - key: pit-wall-panel
      resource: pit-wall-resource
      resolver:
        function: main-resolver
      title: üèÅ Pit Wall
      icon: https://cdn-icons-png.flaticon.com/512/555/555646.png

extensions:
  rovo:action:
    - key: action-create-draft
      name: Create Design Draft
      description: Generates a Confluence design draft from Jira issue context.
      function: cddh
      inputs:
        - name: jiraTicketKey
          type: string
          required: true

    - key: action-prescribe-solution
      name: Prescribe Failure Solution
      description: Performs failure analysis and returns potential redesign guidance.
      function: psh
      inputs:
        - name: jiraTicketKey
          type: string
          required: true
        - name: failureData
          type: string
          required: true

resources:
  - key: pit-wall-resource
    path: static/pit-wall