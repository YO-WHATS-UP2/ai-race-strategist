app:
  id: ari:cloud:ecosystem::app/c7104b49-0a91-46dc-b2c6-de1b156b9b96
  runtime:
    name: nodejs20.x

permissions:
  scopes:
    - storage:app
    - read:jira-work
    - write:jira-work
    - read:content-details:confluence
    - read:content.property:confluence
    - read:confluence-content.all
    - write:confluence-content
    - read:space:confluence
    - write:page:confluence
    - write:content.property:confluence
  content:
    styles:
      - 'unsafe-inline'
    scripts:
      - 'unsafe-inline'
      - 'unsafe-eval'
  external:
    fetch:
      backend:
        - https://api.bitbucket.org
      client:
        - 'https://esm.sh'
        - 'https://api.openai.com'
        - 'https://storage.googleapis.com'
    images:
      - https://cdn-icons-png.flaticon.com

providers:
  auth:
    - key: bitbucket-oauth-v2
      name: Bitbucket Cloud
      type: oauth2
      clientId: "waVaGANqwNGGRqMapM"
      remotes:
        - bitbucket-api
      bearerMethod: authorization-header
      scopes:
        - account
        - repository
      actions:
        authorization:
          remote: bitbucket-website
          path: /site/oauth2/authorize
        exchange:
          remote: bitbucket-website
          path: /site/oauth2/access_token
        retrieveProfile:
          remote: bitbucket-api
          path: /2.0/user
          resolvers:
            id: account_id
            displayName: display_name
            avatarUrl: links.avatar.href

remotes:
  - key: bitbucket-api
    baseUrl: https://api.bitbucket.org
  - key: bitbucket-website
    baseUrl: https://bitbucket.org

modules:
  # âœ… ROVO AGENT DEFINITION
  rovo:agent:
    - key: race-engineer-agent
      name: Race Strategist
      description: An autonomous F1 engineer that monitors telemetry and manages Jira incidents.
      prompt: >
        You are an elite F1 Race Engineer and DevOps Specialist.
        Your job is to monitor vehicle telemetry and explain technical incidents to software teams.
        
        ALWAYS check the 'get-live-status' action first before answering.
        
        If vibration is > 60Hz, use a sense of urgency.
        If vibration is < 60Hz, be calm and professional.
        
        When asked about fixes, refer to the autonomous Bitbucket PRs.
      conversationStarters:
        - "What is the current fleet status?"
        - "Explain the latest anomaly on KAN-42."
        - "Did the autonomous fix deploy successfully?"
      actions:
        - get-live-status
        - get-incident-details

  # âœ… ACTIONS FOR ROVO AGENT (FIXED VALIDATION)
  action:
    - key: get-live-status
      function: agent-status-fn
      actionType: function  # ðŸ‘ˆ Added to fix validation error
      name: Get Live Status
      description: Fetches real-time IoT telemetry data (vibration, temperature) from the Pit Wall.
      
    - key: get-incident-details
      function: agent-incident-fn
      actionType: function  # ðŸ‘ˆ Added to fix validation error
      name: Get Incident Details
      description: Retrieves the Root Cause Analysis and Fix logic for a specific Jira ticket.
      inputs:
        ticketKey:
          title: "Jira Ticket Key"
          type: string
          required: true
          description: "The Jira Issue Key (e.g., KAN-42)"

  confluence:contextMenu:
    - key: dictionary
      function: main
      title: Define word
  
  webtrigger:
    - key: iot-telemetry-trigger
      function: ith

  function:
    # âœ… ROVO AGENT HANDLERS
    - key: agent-status-fn
      handler: index.rovoGetStatus
    - key: agent-incident-fn
      handler: index.rovoGetIncident

    # EXISTING FUNCTIONS
    - key: main
      handler: index.run
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: main-resolver
      handler: index.mainResolver
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: invoke-create-draft
      handler: index.invokeCreateDraft
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: cddh
      handler: index.createDesignDraftHandler
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: psh
      handler: index.prescribeSolutionHandler
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: trigger-fn
      handler: index.triggerHandler
      providers:
        auth:
          - bitbucket-oauth-v2
    - key: ith
      handler: index.ingestTelemetry
    - key: learning-fn
      handler: index.modelRetrainingHandler
      providers:
        auth:
          - bitbucket-oauth-v2

  trigger:
    - key: issue-created-trigger
      function: trigger-fn
      events:
        - avi:jira:created:issue
    - key: issue-updated-trigger
      function: learning-fn
      events:
        - avi:jira:updated:issue

  jira:globalPage:
    - key: pit-wall-global
      resource: pit-wall-resource
      resolver:
        function: main-resolver
      title: ðŸ Pit Wall Auth
      icon: https://cdn-icons-png.flaticon.com/512/555/555646.png

  jira:issuePanel:
    - key: pit-wall-panel
      resource: pit-wall-resource
      resolver:
        function: main-resolver
      title: ðŸ Pit Wall
      icon: https://cdn-icons-png.flaticon.com/512/555/555646.png

  jira:dashboardGadget:
    - key: strategy-dashboard
      title: "ðŸŽï¸ F1 Strategy Command"
      description: "Executive view of Fleet Health and AI Learning Status."
      thumbnail: https://cdn-icons-png.flaticon.com/512/555/555646.png
      resource: dashboard-resource
      resolver:
        function: main-resolver

extensions:
  rovo:action:
    - key: action-create-draft
      name: Create Design Draft
      description: Generates a Confluence design draft from Jira issue context.
      function: cddh
      inputs:
        - name: jiraTicketKey
          type: string
          required: true
    - key: action-prescribe-solution
      name: Prescribe Failure Solution
      description: Performs failure analysis and returns potential redesign guidance.
      function: psh
      inputs:
        - name: jiraTicketKey
          type: string
          required: true
        - name: failureData
          type: string
          required: true

resources:
  - key: pit-wall-resource
    path: static/pit-wall
  - key: dashboard-resource
    path: static/dashboard